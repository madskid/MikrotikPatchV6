name: Patch RouterOS v6 Full (Manual)

on:
  workflow_dispatch:
    inputs:
      routeros_version:
        description: 'RouterOS Version (e.g., 6.42.6)'
        required: true
        default: '6.42.6'
      patch_iso:
        description: 'Patch ISO'
        type: boolean
        default: true
      patch_install_image:
        description: 'Patch Install Image (IMG/ZIP)'
        type: boolean
        default: true
      patch_chr:
        description: 'Patch CHR (IMG/ZIP)'
        type: boolean
        default: true
      publish_release:
        description: 'Publish to GitHub Releases'
        type: boolean
        default: true

permissions:
  contents: write

env:
  # Public Key Original from RouterOS v6.42.6 (Verified)
  MIKRO_NPK_SIGN_PUBLIC_KEY: C275D7235766AEC866D4C59573C8E188A51339936E94D2CCF11F9FF5BAED7137
  MIKRO_LICENSE_PUBLIC_KEY: 8E1067E4305FCDC0CFBF95C10F96E5DFE8C49AEF486BD1A4E2E96C27F01E3E32
  
  # Custom Keys (Derived & Verified)
  CUSTOM_NPK_SIGN_PRIVATE_KEY: 7D008D9B80B036FB0205601FEE79D550927EBCA937B7008CC877281F2F8AC640
  CUSTOM_NPK_SIGN_PUBLIC_KEY: 9522B44B781CBC64E930C563588E6872FBDCDBEF16E963D52BD07E29A15D1B12
  CUSTOM_LICENSE_PRIVATE_KEY: 9DBC845E9018537810FDAE62824322EEE1B12BAD81FCA28EC295FB397C61CE0B
  CUSTOM_LICENSE_PUBLIC_KEY: 723A34A6E3300F23E4BAA06156B9327514AEC170732655F16E04C17928DD770F

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mkisofs xorriso qemu-utils extlinux squashfs-tools zip unzip --no-install-recommends

      # --- PATCH ISO ---
      - name: Patch ISO
        if: ${{ inputs.patch_iso == true }}
        run: |
          VERSION="${{ inputs.routeros_version }}"
          echo "Downloading ISO version $VERSION..."
          curl -s -o mikrotik.iso "https://download.mikrotik.com/routeros/$VERSION/mikrotik-$VERSION.iso"
          
          if [ -s mikrotik.iso ]; then
            mkdir -p iso patched_iso
            sudo mount -o loop,ro mikrotik.iso iso/
            sudo cp -r iso/* patched_iso/
            sudo umount iso/
            sudo rm -rf iso/
            sudo chmod -R u+w patched_iso/
            
            echo "Patching Kernel (ISO)..."
            sudo -E python3 patch.py kernel patched_iso/isolinux/initrd.rgz
            
            echo "Patching NPKs (ISO)..."
            for file in patched_iso/*.npk; do
              echo "Processing $file..."
              sudo -E python3 patch.py npk "$file"
            done
            
            echo "Rebuilding ISO..."
            sudo mkisofs -o "mikrotik-$VERSION-patched.iso" \
               -V "MikroTik $VERSION" \
               -sysid "" -preparer "MiKroTiK" \
               -publisher "" -A "MiKroTiK RouterOS" \
               -input-charset utf-8 \
               -b isolinux/isolinux.bin \
               -c isolinux/boot.cat \
               -no-emul-boot \
               -boot-load-size 4 \
               -boot-info-table \
               -R -J -quiet \
               patched_iso/
            
            sudo rm -rf patched_iso
            echo "ISO Patching Done."
          else
            echo "Failed to download ISO."
          fi

      # --- PATCH INSTALL IMAGE ---
      - name: Patch Install Image
        if: ${{ inputs.patch_install_image == true }}
        run: |
          VERSION="${{ inputs.routeros_version }}"
          echo "Downloading Install Image version $VERSION..."
          curl -s -o install-image.zip "https://download.mikrotik.com/routeros/$VERSION/install-image-$VERSION.zip"
          
          if [ -s install-image.zip ]; then
            unzip install-image.zip
            IMG_FILE="install-image-$VERSION.img"
            
            # Load NBD module
            sudo modprobe nbd
            
            # Connect image to NBD
            sudo qemu-nbd -c /dev/nbd0 -f raw "$IMG_FILE"
            
            mkdir -p install_mount
            # Install Image usually has one partition or is a superfloppy
            # Try mounting the device directly first
            sudo mount /dev/nbd0 install_mount/ || sudo mount /dev/nbd0p1 install_mount/
            
            echo "Patching Kernel (Install Image)..."
            # Location might vary, usually initrd.rgz is at root or /boot
            if [ -f "install_mount/initrd.rgz" ]; then
                sudo -E python3 patch.py kernel install_mount/initrd.rgz
            elif [ -f "install_mount/boot/initrd.rgz" ]; then
                sudo -E python3 patch.py kernel install_mount/boot/initrd.rgz
            else
                echo "Warning: initrd.rgz not found in install-image!"
            fi
            
            echo "Patching NPKs (Install Image)..."
            NPK_FILES=$(find install_mount/ -name "*.npk")
            for file in $NPK_FILES; do
              echo "Processing $file..."
              sudo -E python3 patch.py npk "$file"
            done
            
            sudo umount install_mount
            sudo qemu-nbd -d /dev/nbd0
            rm -rf install_mount
            
            # Zip it back
            mv "$IMG_FILE" "install-image-$VERSION-patched.img"
            zip "install-image-$VERSION-patched.zip" "install-image-$VERSION-patched.img"
            rm "install-image-$VERSION-patched.img"
            
            echo "Install Image Patching Done."
          else
             echo "Failed to download Install Image."
          fi

      # --- PATCH CHR ---
      - name: Patch CHR
        if: ${{ inputs.patch_chr == true }}
        run: |
          VERSION="${{ inputs.routeros_version }}"
          echo "Downloading CHR version $VERSION..."
          curl -s -o chr.img.zip "https://download.mikrotik.com/routeros/$VERSION/chr-$VERSION.img.zip"
          
          if [ -s chr.img.zip ]; then
            unzip chr.img.zip
            IMG_FILE="chr-$VERSION.img"
            
            # 1. Prepare Patched System NPK
            # In v6, the system package is usually inside the bundle or separate.
            # Assuming we need a patched system.npk to extract kernel/initrd from.
            # We can use the one from the ISO or download it.
            # For simplicity, if we patched the ISO, we have them. 
            # If not, let's just use the one we are about to patch for the image.
            
            # CHR image has the system npk in p2. Let's extract it first, patch it, then use it.
            sudo modprobe nbd
            sudo qemu-nbd -c /dev/nbd1 -f raw "$IMG_FILE"
            
            mkdir -p chr_boot chr_ros
            sudo mount /dev/nbd1p1 chr_boot/
            sudo mount /dev/nbd1p2 chr_ros/
            
            # Find system package in CHR
            SYSTEM_IMAGE_CANDIDATES=$(sudo find chr_ros/var/pdb -name "image" | xargs grep -l "system" || true)
            SYSTEM_IMAGE=""
            for candidate in $SYSTEM_IMAGE_CANDIDATES; do
                if [[ "$candidate" == *"routeros-x86"* ]]; then
                    SYSTEM_IMAGE="$candidate"
                    break
                fi
            done
            # Fallback if no specific x86 package found, take the first one
            if [ -z "$SYSTEM_IMAGE" ]; then
                 SYSTEM_IMAGE=$(echo "$SYSTEM_IMAGE_CANDIDATES" | head -n 1)
            fi

            if [ -z "$SYSTEM_IMAGE" ]; then
               # Try finding any npk
               SYSTEM_IMAGE=$(sudo find chr_ros/ -name "system-*.npk" | head -n 1)
            fi
            
            if [ -n "$SYSTEM_IMAGE" ]; then
               echo "Found system package at $SYSTEM_IMAGE. Patching..."
               sudo cp "$SYSTEM_IMAGE" ./system_to_patch.npk
               sudo -E python3 patch.py npk ./system_to_patch.npk
               
               # 1. Patch Kernel/Initrd directly on Boot Partition (Preserves CHR-specific drivers)
               echo "Patching Kernel/Initrd on Boot Partition..."
               
               # Find existing kernel/initrd
               KERNEL_FILE=""
               for f in "vmlinuz" "kernel" "boot/vmlinuz" "boot/kernel"; do
                   if [ -f "./chr_boot/$f" ]; then
                       KERNEL_FILE="./chr_boot/$f"
                       break
                   fi
               done
               
               INITRD_FILE=""
               for f in "initrd.rgz" "boot/initrd.rgz"; do
                   if [ -f "./chr_boot/$f" ]; then
                       INITRD_FILE="./chr_boot/$f"
                       break
                   fi
               done
               
               if [ -n "$KERNEL_FILE" ]; then
                   echo "Found kernel at $KERNEL_FILE. Patching..."
                   sudo -E python3 patch.py kernel "$KERNEL_FILE"
               else
                   echo "Error: No kernel file found on boot partition!"
                   ls -R ./chr_boot
                   exit 1
               fi

               if [ -n "$INITRD_FILE" ]; then
                   echo "Found initrd at $INITRD_FILE. Patching..."
                   sudo -E python3 patch.py kernel "$INITRD_FILE"
               else
                   echo "Error: No initrd file found on boot partition!"
                   ls -R ./chr_boot
                   exit 1
               fi

               echo "Installing Syslinux..."
               sudo mkdir -p chr_boot/BOOT
               sudo extlinux --install -H 64 -S 32 chr_boot/BOOT
               
               # Get relative paths for syslinux (stripped of ./chr_boot)
               REL_KERNEL=${KERNEL_FILE#./chr_boot}
               REL_INITRD=${INITRD_FILE#./chr_boot}
               
               # Update syslinux config
               echo -e "default system\nlabel system\n\tkernel $REL_KERNEL\n\tinitrd $REL_INITRD\n\tappend load_ramdisk=1 root=/dev/ram0 quiet" | sudo tee syslinux.cfg > /dev/null
               sudo cp syslinux.cfg chr_boot/BOOT/
               
               # 2. Patch all other packages in Data Partition
               echo "Patching all CHR Packages..."
               PDB_IMAGES=$(sudo find chr_ros/var/pdb -name "image")
               for file in $PDB_IMAGES; do
                  echo "Processing $file"
                  sudo -E python3 patch.py npk "$file"
               done
               
               NPK_FILES=$(sudo find chr_ros/ -name "*.npk")
               for file in $NPK_FILES; do
                  echo "Processing $file..."
                  sudo -E python3 patch.py npk "$file"
               done
            else
               echo "Error: Could not find system package in CHR image!"
               exit 1
            fi
            
            sudo umount chr_boot
            sudo umount chr_ros
            sudo qemu-nbd -d /dev/nbd1
            rm -rf chr_boot chr_ros
            
            # Zip it back
            mv "$IMG_FILE" "chr-$VERSION-patched.img"
            zip "chr-$VERSION-patched.img.zip" "chr-$VERSION-patched.img"
            rm "chr-$VERSION-patched.img"
            
            echo "CHR Patching Done."
          else
            echo "Failed to download CHR."
          fi

      - name: Create Release
        if: ${{ inputs.publish_release == true }}
        uses: softprops/action-gh-release@v2
        with:
          name: "RouterOS ${{ inputs.routeros_version }} (Patched)"
          tag_name: "v${{ inputs.routeros_version }}"
          body: |
            Patched RouterOS ${{ inputs.routeros_version }}.
            
            **Artifacts:**
            - ISO: CD/DVD Installation
            - Install Image: Netinstall / Flash
            - CHR: Cloud Hosted Router Image
            
            **Keys used:**
            - Public Key (Check): `C275...`
            - Signing Algorithm: SHA1 (Legacy)
          files: |
            mikrotik-${{ inputs.routeros_version }}-patched.iso
            install-image-${{ inputs.routeros_version }}-patched.zip
            chr-${{ inputs.routeros_version }}-patched.img.zip
