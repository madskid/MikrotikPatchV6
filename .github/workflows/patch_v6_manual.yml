name: Patch RouterOS v6 (Manual)

on:
  workflow_dispatch:
    inputs:
      routeros_version:
        description: 'RouterOS Version (e.g., 6.42.6)'
        required: true
        default: '6.42.6'
      publish_release:
        description: 'Publish to GitHub Releases'
        type: boolean
        default: true

permissions:
  contents: write

env:
  # Public Key Original from RouterOS v6.42.6 (Verified)
  MIKRO_NPK_SIGN_PUBLIC_KEY: C275D7235766AEC866D4C59573C8E188A51339936E94D2CCF11F9FF5BAED7137
  MIKRO_LICENSE_PUBLIC_KEY: 8E1067E4305FCDC0CFBF95C10F96E5DFE8C49AEF486BD1A4E2E96C27F01E3E32
  
  # Custom Keys (Derived & Verified)
  # Note: For v6, we use NPK key for signing packages logic
  CUSTOM_NPK_SIGN_PRIVATE_KEY: 7D008D9B80B036FB0205601FEE79D550927EBCA937B7008CC877281F2F8AC640
  CUSTOM_NPK_SIGN_PUBLIC_KEY: 9522B44B781CBC64E930C563588E6872FBDCDBEF16E963D52BD07E29A15D1B12
  CUSTOM_LICENSE_PRIVATE_KEY: 9DBC845E9018537810FDAE62824322EEE1B12BAD81FCA28EC295FB397C61CE0B
  CUSTOM_LICENSE_PUBLIC_KEY: 723A34A6E3300F23E4BAA06156B9327514AEC170732655F16E04C17928DD770F

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mkisofs xorriso qemu-utils extlinux squashfs-tools zip unzip --no-install-recommends

      - name: Download RouterOS ${{ inputs.routeros_version }}
        run: |
          VERSION="${{ inputs.routeros_version }}"
          echo "Downloading version $VERSION..."
          curl -s -o mikrotik.iso "https://download.mikrotik.com/routeros/$VERSION/mikrotik-$VERSION.iso"
          
          # Check if file exists and is not empty
          if [ ! -s mikrotik.iso ]; then
            echo "Error: Failed to download ISO or file is empty."
            exit 1
          fi

      - name: Patch ISO
        run: |
          VERSION="${{ inputs.routeros_version }}"
          
          # 1. Prepare Directories
          mkdir -p iso patched_iso
          sudo mount -o loop,ro mikrotik.iso iso/
          sudo cp -r iso/* patched_iso/
          sudo umount iso/
          sudo rm -rf iso/
          
          # Ensure permissions
          sudo chmod -R u+w patched_iso/
          
          # 2. Patch Kernel (initrd.rgz)
          echo "Patching Kernel..."
          sudo -E python3 patch.py kernel patched_iso/isolinux/initrd.rgz
          
          # 3. Patch NPK Packages
          echo "Patching NPK Packages..."
          # Iterate over all NPK files in the directory
          for file in patched_iso/*.npk; do
            echo "Processing $file..."
            sudo -E python3 patch.py npk "$file"
          done
          
          # 4. Rebuild ISO
          echo "Rebuilding ISO..."
          sudo mkisofs -o "mikrotik-$VERSION-patched.iso" \
             -V "MikroTik $VERSION" \
             -sysid "" -preparer "MiKroTiK" \
             -publisher "" -A "MiKroTiK RouterOS" \
             -input-charset utf-8 \
             -b isolinux/isolinux.bin \
             -c isolinux/boot.cat \
             -no-emul-boot \
             -boot-load-size 4 \
             -boot-info-table \
             -R -J \
             -quiet \
             patched_iso/
             
          echo "ISO Patching Complete."
          ls -lh "mikrotik-$VERSION-patched.iso"

      - name: Create Release
        if: ${{ inputs.publish_release == true }}
        uses: softprops/action-gh-release@v2
        with:
          name: "RouterOS ${{ inputs.routeros_version }} (Patched)"
          tag_name: "v${{ inputs.routeros_version }}"
          body: |
            Patched RouterOS ${{ inputs.routeros_version }} for x86.
            
            **Keys used:**
            - Public Key (Check): `C275...`
            - Signing Algorithm: SHA1 (Legacy)
          files: |
            mikrotik-${{ inputs.routeros_version }}-patched.iso
