name: Patch RouterOS v6 (Manual)

on:
  workflow_dispatch:
    inputs:
      routeros_version:
        description: 'RouterOS Version (e.g., 6.42.6)'
        required: true
        default: '6.42.6'
      publish_release:
        description: 'Publish to GitHub Releases'
        type: boolean
        default: true

permissions:
  contents: write

env:
  # Public Key Original from RouterOS v6.42.6 (Verified)
  MIKRO_NPK_SIGN_PUBLIC_KEY: C275D7235766AEC866D4C59573C8E188A51339936E94D2CCF11F9FF5BAED7137
  MIKRO_LICENSE_PUBLIC_KEY: 8E1067E4305FCDC0CFBF95C10F96E5DFE8C49AEF486BD1A4E2E96C27F01E3E32
  
  # Custom Keys (Derived & Verified)
  # Note: For v6, we use NPK key for signing packages logic
  CUSTOM_NPK_SIGN_PRIVATE_KEY: 7D008D9B80B036FB0205601FEE79D550927EBCA937B7008CC877281F2F8AC640
  CUSTOM_NPK_SIGN_PUBLIC_KEY: 9522B44B781CBC64E930C563588E6872FBDCDBEF16E963D52BD07E29A15D1B12
  CUSTOM_LICENSE_PRIVATE_KEY: 9DBC845E9018537810FDAE62824322EEE1B12BAD81FCA28EC295FB397C61CE0B
  CUSTOM_LICENSE_PUBLIC_KEY: 723A34A6E3300F23E4BAA06156B9327514AEC170732655F16E04C17928DD770F

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mkisofs xorriso qemu-utils extlinux squashfs-tools zip unzip --no-install-recommends

      - name: Download RouterOS ${{ inputs.routeros_version }}
        run: |
          VERSION="${{ inputs.routeros_version }}"
          echo "Downloading version $VERSION..."
          curl -s -o mikrotik.iso "https://download.mikrotik.com/routeros/$VERSION/mikrotik-$VERSION.iso"
          
          # Check if file exists and is not empty
          if [ ! -s mikrotik.iso ]; then
            echo "Error: Failed to download ISO or file is empty."
            exit 1
          fi

      - name: Patch ISO
        run: |
          VERSION="${{ inputs.routeros_version }}"
          
          # 1. Prepare Directories
          mkdir -p iso patched_iso
          sudo mount -o loop,ro mikrotik.iso iso/
          sudo cp -r iso/* patched_iso/
          sudo umount iso/
          sudo rm -rf iso/
          
          # Ensure permissions
          sudo chmod -R u+w patched_iso/
          
          # 2. Patch Kernel (initrd.rgz)
          echo "Patching Kernel..."
          sudo -E python3 patch.py kernel patched_iso/isolinux/initrd.rgz
          
          # 3. Patch NPK Packages
          echo "Patching NPK Packages..."
          # Iterate over all NPK files in the directory
          for file in patched_iso/*.npk; do
            echo "Processing $file..."
            sudo -E python3 patch.py npk "$file"
          done
          
          # 4. Rebuild ISO
          echo "Rebuilding ISO..."
          sudo mkisofs -o "mikrotik-$VERSION-patched.iso" \
             -V "MikroTik $VERSION" \
             -sysid "" -preparer "MiKroTiK" \
             -publisher "" -A "MiKroTiK RouterOS" \
             -input-charset utf-8 \
             -b isolinux/isolinux.bin \
             -c isolinux/boot.cat \
             -no-emul-boot \
             -boot-load-size 4 \
             -boot-info-table \
             -R -J \
             -quiet \
             patched_iso/
             
          echo "ISO Patching Complete."
          ls -lh "mikrotik-$VERSION-patched.iso"

      - name: Patch CHR
        run: |
          VERSION="${{ inputs.routeros_version }}"
          echo "Downloading CHR version $VERSION..."
          curl -s -o chr.img.zip "https://download.mikrotik.com/routeros/$VERSION/chr-$VERSION.img.zip"
          
          if [ ! -s chr.img.zip ]; then
            echo "Error: Failed to download CHR."
            exit 1
          fi
          
          unzip chr.img.zip
          IMG_FILE="chr-$VERSION.img"
          
          # Load NBD module
          sudo modprobe nbd max_part=8 || true
          
          # Connect image
          sudo qemu-nbd -c /dev/nbd0 -f raw "$IMG_FILE"
          sleep 2
          
          mkdir -p mnt_boot mnt_ros
          
          # Check partitions
          if [ ! -b /dev/nbd0p1 ]; then
             echo "Error: Partitions not found on /dev/nbd0"
             ls -l /dev/nbd*
             exit 1
          fi
          
          sudo mount /dev/nbd0p1 mnt_boot/
          sudo mount /dev/nbd0p2 mnt_ros/
          
          # 1. Find and Patch Kernel & Initrd
          echo "Inspecting boot partition..."
          ls -R mnt_boot/
          
          KERNEL_FILE=""
          # Priority list for kernel files
          for candidate in "EFI/BOOT/BOOTX64.EFI" "boot/kernel" "kernel" "linux" "vmlinuz"; do
             if [ -f "mnt_boot/$candidate" ]; then
                KERNEL_FILE="$candidate"
                break
             fi
          done
          
          if [ -z "$KERNEL_FILE" ]; then
             echo "Error: Could not find kernel file in mnt_boot!"
             exit 1
          fi
          
          echo "Found Kernel: $KERNEL_FILE"
          echo "Patching Kernel..."
          sudo -E python3 patch.py kernel "mnt_boot/$KERNEL_FILE"

          INITRD_FILE=""
          if [ -f "mnt_boot/boot/initrd.rgz" ]; then
             INITRD_FILE="boot/initrd.rgz"
          elif [ -f "mnt_boot/initrd.rgz" ]; then
             INITRD_FILE="initrd.rgz"
          fi
          
          if [ -n "$INITRD_FILE" ]; then
             echo "Found Initrd: $INITRD_FILE"
             echo "Patching Initrd..."
             sudo -E python3 patch.py kernel "mnt_boot/$INITRD_FILE"
             INITRD_PARAM="initrd=/$INITRD_FILE"
          else
             echo "Warning: No separate initrd found (might be embedded)."
             INITRD_PARAM=""
          fi
          
          # 2. Install Syslinux (Legacy Bootloader)
          echo "Configuring Syslinux..."
          sudo mkdir -p mnt_boot/BOOT
          sudo extlinux --install -H 64 -S 32 mnt_boot/BOOT
          
          # Note: Paths in syslinux.cfg are relative to partition root, usually starting with /
          echo -e "default system\nlabel system\n\tkernel /$KERNEL_FILE\n\tappend load_ramdisk=1 root=/dev/ram0 quiet $INITRD_PARAM" | sudo tee syslinux.cfg > /dev/null
          sudo cp syslinux.cfg mnt_boot/BOOT/
          
          # 4. Patch Packages (RouterOS)
          echo "Patching CHR Packages..."
          PDB_IMAGES=$(sudo find mnt_ros/var/pdb -name "image")
          for file in $PDB_IMAGES; do
             echo "Processing CHR package: $file"
             sudo -E python3 patch.py npk "$file"
          done
          
          NPK_FILES=$(sudo find mnt_ros/ -name "*.npk")
          for file in $NPK_FILES; do
             echo "Processing $file..."
             sudo -E python3 patch.py npk "$file"
          done
          
          sudo umount mnt_boot
          sudo umount mnt_ros
          sudo qemu-nbd -d /dev/nbd0
          rm -rf mnt_boot mnt_ros
          
          # Zip result
          zip "chr-$VERSION-patched.img.zip" "$IMG_FILE"
          
          echo "CHR Patching Complete."
          ls -lh "chr-$VERSION-patched.img.zip"

      - name: Create Release
        if: ${{ inputs.publish_release == true }}
        uses: softprops/action-gh-release@v2
        with:
          name: "RouterOS ${{ inputs.routeros_version }} (Patched)"
          tag_name: "v${{ inputs.routeros_version }}"
          body: |
            Patched RouterOS ${{ inputs.routeros_version }} for x86.
            
            **Artifacts:**
            - **ISO:** CD/DVD Installation
            - **CHR:** Cloud Hosted Router Image (ReFind Bootloader)
            
            **Keys used:**
            - Public Key (Check): `C275...`
            - Signing Algorithm: SHA1 (Legacy)
          files: |
            mikrotik-${{ inputs.routeros_version }}-patched.iso
            chr-${{ inputs.routeros_version }}-patched.img.zip
